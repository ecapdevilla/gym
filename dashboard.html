<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PowerGym</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="shared.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">üèãÔ∏è PowerGym</h1>
                <span id="userRole" class="bg-blue-500 px-2 py-1 rounded text-sm"></span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="userName" class="hidden md:block"></span>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span class="hidden md:inline">Salir</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu Button -->
    <div class="bg-blue-500 text-white p-2 md:hidden">
        <button id="mobileMenuBtn" class="w-full text-left">
            <i class="fas fa-bars mr-2"></i> Men√∫
        </button>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto p-4 flex">
        <!-- Sidebar -->
        <div id="sidebar" class="hidden md:block w-64 bg-white rounded-lg shadow-lg p-4 mr-4">
            <nav class="space-y-2">
                <a href="dashboard.html" class="block bg-blue-100 text-blue-700 p-3 rounded-lg font-bold">
                    <i class="fas fa-chart-bar mr-2"></i>Dashboard
                </a>
                
                <a href="miembros.html" class="block hover:bg-gray-100 p-3 rounded-lg">
                    <i class="fas fa-users mr-2"></i>Miembros
                </a>
                
                <a href="planes.html" class="block hover:bg-gray-100 p-3 rounded-lg">
                    <i class="fas fa-credit-card mr-2"></i>Planes
                </a>
                
                <a href="asistencia.html" class="block hover:bg-gray-100 p-3 rounded-lg">
                    <i class="fas fa-clipboard-check mr-2"></i>Asistencia
                </a>
                
                <a href="rutinas.html" class="block hover:bg-gray-100 p-3 rounded-lg">
                    <i class="fas fa-dumbbell mr-2"></i>Rutinas
                </a>
                
                <a href="coaches.html" class="block hover:bg-gray-100 p-3 rounded-lg">
                    <i class="fas fa-user-tie mr-2"></i>Coaches
                </a>
                
                <a href="inventario.html" class="block hover:bg-gray-100 p-3 rounded-lg">
                    <i class="fas fa-boxes mr-2"></i>Inventario
                </a>
                
                <a href="ventas.html" class="block hover:bg-gray-100 p-3 rounded-lg">
                    <i class="fas fa-cash-register mr-2"></i>Ventas
                </a>
                
                <a href="finanzas.html" class="block hover:bg-gray-100 p-3 rounded-lg">
                    <i class="fas fa-chart-line mr-2"></i>Finanzas
                </a>
                
                <a href="recordatorios.html" class="block hover:bg-gray-100 p-3 rounded-lg">
                    <i class="fas fa-bell mr-2"></i>Recordatorios
                </a>
            </nav>
        </div>

        <!-- Dashboard Content -->
        <div class="flex-1">
            <!-- Welcome Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="welcomeMessage">Bienvenido</h2>
                <p class="text-gray-600" id="dashboardDate"></p>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Total Members -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Miembros Activos</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="totalMembers">0</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-users text-blue-500 text-xl"></i>
                        </div>
                    </div>
                    <p class="text-green-500 text-sm mt-2" id="membersGrowth">+0 este mes</p>
                </div>

                <!-- Today's Attendance -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Asistencia Hoy</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="todayAttendance">0</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-clipboard-check text-green-500 text-xl"></i>
                        </div>
                    </div>
                    <p class="text-gray-500 text-sm mt-2" id="attendanceTime">Actualizado ahora</p>
                </div>

                <!-- Monthly Revenue -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Ingresos Mes</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="monthlyRevenue">$0</h3>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <i class="fas fa-dollar-sign text-yellow-500 text-xl"></i>
                        </div>
                    </div>
                    <p class="text-green-500 text-sm mt-2" id="revenueGrowth">+0% vs mes anterior</p>
                </div>

                <!-- Low Stock Alert -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Stock Bajo</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="lowStockCount">0</h3>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                        </div>
                    </div>
                    <p class="text-red-500 text-sm mt-2" id="stockAlert">Productos por reordenar</p>
                </div>
            </div>

            <!-- Charts and Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Recent Members -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-user-plus mr-2 text-blue-500"></i>
                        Miembros Recientes
                    </h3>
                    <div id="recentMembers" class="space-y-3">
                        <!-- Los miembros recientes se cargar√°n aqu√≠ -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-bolt mr-2 text-yellow-500"></i>
                        Acciones R√°pidas
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="location.href='asistencia.html'" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg text-center">
                            <i class="fas fa-clipboard-check text-2xl mb-2"></i>
                            <p>Registrar Asistencia</p>
                        </button>
                        
                        <button onclick="location.href='ventas.html'" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg text-center">
                            <i class="fas fa-cash-register text-2xl mb-2"></i>
                            <p>Nueva Venta</p>
                        </button>
                        
                        <button onclick="location.href='miembros.html'" class="bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-lg text-center">
                            <i class="fas fa-user-plus text-2xl mb-2"></i>
                            <p>Agregar Miembro</p>
                        </button>
                        
                        <button onclick="location.href='recordatorios.html'" class="bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-lg text-center">
                            <i class="fas fa-bell text-2xl mb-2"></i>
                            <p>Enviar Recordatorios</p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pending Tasks -->
            <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fas fa-tasks mr-2 text-green-500"></i>
                    Tareas Pendientes
                </h3>
                <div id="pendingTasks" class="space-y-2">
                    <!-- Las tareas pendientes se cargar√°n aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Modal -->
    <div id="mobileMenu" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden md:hidden">
        <div class="bg-white w-64 h-full p-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold">Men√∫</h3>
                <button onclick="closeMobileMenu()" class="text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="space-y-2">
                <a href="dashboard.html" class="block bg-blue-100 text-blue-700 p-3 rounded-lg font-bold" onclick="closeMobileMenu()">
                    <i class="fas fa-chart-bar mr-2"></i>Dashboard
                </a>
                <a href="miembros.html" class="block hover:bg-gray-100 p-3 rounded-lg" onclick="closeMobileMenu()">
                    <i class="fas fa-users mr-2"></i>Miembros
                </a>
                <a href="planes.html" class="block hover:bg-gray-100 p-3 rounded-lg" onclick="closeMobileMenu()">
                    <i class="fas fa-credit-card mr-2"></i>Planes
                </a>
                <a href="asistencia.html" class="block hover:bg-gray-100 p-3 rounded-lg" onclick="closeMobileMenu()">
                    <i class="fas fa-clipboard-check mr-2"></i>Asistencia
                </a>
                <a href="rutinas.html" class="block hover:bg-gray-100 p-3 rounded-lg" onclick="closeMobileMenu()">
                    <i class="fas fa-dumbbell mr-2"></i>Rutinas
                </a>
                <a href="coaches.html" class="block hover:bg-gray-100 p-3 rounded-lg" onclick="closeMobileMenu()">
                    <i class="fas fa-user-tie mr-2"></i>Coaches
                </a>
                <a href="inventario.html" class="block hover:bg-gray-100 p-3 rounded-lg" onclick="closeMobileMenu()">
                    <i class="fas fa-boxes mr-2"></i>Inventario
                </a>
                <a href="ventas.html" class="block hover:bg-gray-100 p-3 rounded-lg" onclick="closeMobileMenu()">
                    <i class="fas fa-cash-register mr-2"></i>Ventas
                </a>
                <a href="finanzas.html" class="block hover:bg-gray-100 p-3 rounded-lg" onclick="closeMobileMenu()">
                    <i class="fas fa-chart-line mr-2"></i>Finanzas
                </a>
                <a href="recordatorios.html" class="block hover:bg-gray-100 p-3 rounded-lg" onclick="closeMobileMenu()">
                    <i class="fas fa-bell mr-2"></i>Recordatorios
                </a>
            </nav>
        </div>
    </div>

    <script>
        // Navigation
        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            document.getElementById('mobileMenu').classList.remove('hidden');
        });

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.add('hidden');
        }

        function logout() {
            AuthManager.logout();
            window.location.href = 'index.html';
        }

        // Dashboard Data
        function loadDashboardData() {
            const user = AuthManager.getCurrentUser();
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // User Info
            document.getElementById('userName').textContent = `${user.name} ${user.last_name || ''}`;
            document.getElementById('userRole').textContent = user.role.toUpperCase();
            document.getElementById('welcomeMessage').textContent = `Bienvenido, ${user.name}`;
            document.getElementById('dashboardDate').textContent = `Hoy es ${new Date().toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;

            // Load Stats
            loadStats();
            loadRecentMembers();
            loadPendingTasks();
        }

        function loadStats() {
            const members = LocalStorageDriver.getAll('members');
            const attendance = LocalStorageDriver.getAll('attendance');
            const sales = LocalStorageDriver.getAll('sales');
            const inventory = LocalStorageDriver.getAll('inventory');

            // Total Members
            const activeMembers = members.filter(m => m.status === 'active');
            document.getElementById('totalMembers').textContent = activeMembers.length;

            // Today's Attendance
            const today = new Date().toDateString();
            const todayAttendance = attendance.filter(a => {
                const checkInDate = new Date(a.check_in).toDateString();
                return checkInDate === today;
            });
            document.getElementById('todayAttendance').textContent = todayAttendance.length;

            // Monthly Revenue
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlySales = sales.filter(s => {
                const saleDate = new Date(s.date);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            const monthlyRevenue = monthlySales.reduce((total, sale) => total + (sale.total || 0), 0);
            document.getElementById('monthlyRevenue').textContent = Utilities.formatCurrency(monthlyRevenue);

            // Low Stock
            const lowStockItems = inventory.filter(item => item.stock <= (item.min_stock || 5));
            document.getElementById('lowStockCount').textContent = lowStockItems.length;
        }

        function loadRecentMembers() {
            const members = LocalStorageDriver.getAll('members')
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 5);

            const container = document.getElementById('recentMembers');
            container.innerHTML = '';

            if (members.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No hay miembros registrados</p>';
                return;
            }

            members.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'flex items-center justify-between p-2 hover:bg-gray-50 rounded';
                memberElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-sm"></i>
                        </div>
                        <div>
                            <p class="font-medium">${member.name} ${member.last_name || ''}</p>
                            <p class="text-sm text-gray-500">${Utilities.formatDate(member.created_at)}</p>
                        </div>
                    </div>
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">${member.plan_id || 'Sin plan'}</span>
                `;
                container.appendChild(memberElement);
            });
        }

        function loadPendingTasks() {
            const tasks = [
                { type: 'inactive_members', count: getInactiveMembersCount(), icon: 'fa-user-clock', color: 'orange' },
                { type: 'pending_payments', count: getPendingPaymentsCount(), icon: 'fa-money-bill-wave', color: 'red' },
                { type: 'low_stock', count: getLowStockCount(), icon: 'fa-boxes', color: 'yellow' }
            ];

            const container = document.getElementById('pendingTasks');
            container.innerHTML = '';

            tasks.forEach(task => {
                if (task.count > 0) {
                    const taskElement = document.createElement('div');
                    taskElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    taskElement.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas ${task.icon} text-${task.color}-500 mr-3"></i>
                            <span>${getTaskDescription(task.type)}</span>
                        </div>
                        <span class="bg-${task.color}-500 text-white px-2 py-1 rounded-full text-sm">${task.count}</span>
                    `;
                    container.appendChild(taskElement);
                }
            });

            if (container.children.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">¬°No hay tareas pendientes! Todo est√° al d√≠a.</p>';
            }
        }

        function getInactiveMembersCount() {
            // Miembros que no han asistido en 15 d√≠as
            const members = LocalStorageDriver.getAll('members');
            const attendance = LocalStorageDriver.getAll('attendance');
            const fifteenDaysAgo = new Date();
            fifteenDaysAgo.setDate(fifteenDaysAgo.getDate() - 15);

            return members.filter(member => {
                const lastAttendance = attendance
                    .filter(a => a.member_id === member.id)
                    .sort((a, b) => new Date(b.check_in) - new Date(a.check_in))[0];
                
                return !lastAttendance || new Date(lastAttendance.check_in) < fifteenDaysAgo;
            }).length;
        }

        function getPendingPaymentsCount() {
            // L√≥gica simplificada para pagos pendientes
            const members = LocalStorageDriver.getAll('members');
            return members.filter(m => m.status === 'active').length; // Ejemplo simplificado
        }

        function getLowStockCount() {
            const inventory = LocalStorageDriver.getAll('inventory');
            return inventory.filter(item => item.stock <= (item.min_stock || 5)).length;
        }

        function getTaskDescription(type) {
            const descriptions = {
                'inactive_members': 'Miembros inactivos (15+ d√≠as)',
                'pending_payments': 'Pagos pendientes',
                'low_stock': 'Productos con stock bajo'
            };
            return descriptions[type] || type;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            
            // Refresh data every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
    </script>
</body>
</html>