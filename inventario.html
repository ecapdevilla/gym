<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario - PowerGym</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="shared.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="dashboard.html" class="text-white hover:text-blue-200">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-xl font-bold">📦 Gestión de Inventario</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="userName" class="hidden md:block"></span>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span class="hidden md:inline">Salir</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="bg-blue-500 text-white p-2 md:hidden">
        <button onclick="goToDashboard()" class="w-full text-left">
            <i class="fas fa-arrow-left mr-2"></i> Volver al Dashboard
        </button>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Header Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="totalProducts">0</div>
                <div class="text-gray-600 text-sm">Total Productos</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="inStockProducts">0</div>
                <div class="text-gray-600 text-sm">En Stock</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-orange-600" id="lowStockProducts">0</div>
                <div class="text-gray-600 text-sm">Stock Bajo</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-red-600" id="outOfStockProducts">0</div>
                <div class="text-gray-600 text-sm">Sin Stock</div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="flex space-x-4">
                    <button onclick="showAddProductModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-plus mr-2"></i> Nuevo Producto
                    </button>
                    <button onclick="showQuickSaleModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-cash-register mr-2"></i> Venta Rápida
                    </button>
                    <button onclick="showCategoriesModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-tags mr-2"></i> Categorías
                    </button>
                </div>
                <div class="flex space-x-2">
                    <select id="categoryFilter" onchange="filterProducts()" class="p-2 border border-gray-300 rounded-lg">
                        <option value="all">Todas las categorías</option>
                        <!-- Las categorías se cargarán aquí -->
                    </select>
                    <select id="stockFilter" onchange="filterProducts()" class="p-2 border border-gray-300 rounded-lg">
                        <option value="all">Todo el stock</option>
                        <option value="in_stock">En stock</option>
                        <option value="low_stock">Stock bajo</option>
                        <option value="out_of_stock">Sin stock</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Categoría</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">Precio</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable" class="bg-white divide-y divide-gray-200">
                        <!-- Los productos se cargarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12 hidden">
            <i class="fas fa-boxes text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900">No hay productos en inventario</h3>
            <p class="text-gray-500 mt-1">Comienza agregando tu primer producto.</p>
            <button onclick="showAddProductModal()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                <i class="fas fa-plus mr-2"></i>Agregar Producto
            </button>
        </div>

        <!-- Low Stock Alert -->
        <div id="lowStockAlert" class="bg-orange-50 border border-orange-200 rounded-lg p-4 mt-6 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-orange-500 text-xl mr-3"></i>
                    <div>
                        <h4 class="font-bold text-orange-800">Alerta de Stock Bajo</h4>
                        <p class="text-orange-700 text-sm" id="lowStockMessage"></p>
                    </div>
                </div>
                <button onclick="hideLowStockAlert()" class="text-orange-500 hover:text-orange-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold" id="productModalTitle">Agregar Nuevo Producto</h3>
                    <button onclick="closeAddProductModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="productForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto *</label>
                            <input type="text" id="productName" required 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Ej: Proteína Whey 2kg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Categoría *</label>
                            <select id="productCategory" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Seleccionar categoría...</option>
                                <!-- Las categorías se cargarán aquí -->
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Código/SKU</label>
                            <input type="text" id="productSKU" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="OPCIONAL">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                            <input type="text" id="productSupplier" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Ej: Suplementos S.A.">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Precio de Compra (COP)</label>
                            <input type="number" id="productCost" min="0" step="100"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="50000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Precio de Venta (COP) *</label>
                            <input type="number" id="productPrice" required min="0" step="100"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="80000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Margen de Ganancia</label>
                            <input type="text" id="productMargin" readonly
                                   class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stock Actual *</label>
                            <input type="number" id="productStock" required min="0"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stock Mínimo</label>
                            <input type="number" id="productMinStock" min="0"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="10">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Stock Máximo</label>
                            <input type="number" id="productMaxStock" min="0"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="100">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                        <textarea id="productDescription" rows="3"
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Descripción del producto..."></textarea>
                    </div>

                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="productActive" class="rounded text-blue-500" checked>
                        <label for="productActive" class="text-sm font-medium text-gray-700">Producto activo para venta</label>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeAddProductModal()" 
                                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            <span id="productSubmitText">Guardar Producto</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="productDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold" id="detailProductName">Detalles del Producto</h3>
                    <button onclick="closeProductDetailsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="productDetailsContent">
                    <!-- Los detalles del producto se cargarán aquí -->
                </div>

                <div class="mt-6 flex space-x-3">
                    <button onclick="closeProductDetailsModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cerrar
                    </button>
                    <button id="editProductBtn" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        Editar Producto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Sale Modal -->
    <div id="quickSaleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Venta Rápida</h3>
                    <button onclick="closeQuickSaleModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buscar Producto</label>
                        <input type="text" id="saleProductSearch" placeholder="Nombre del producto..." 
                               class="w-full p-3 border border-gray-300 rounded-lg" onkeyup="searchProductsForSale()">
                    </div>

                    <div id="saleProductsList" class="max-h-64 overflow-y-auto space-y-2">
                        <!-- Los productos para venta se cargarán aquí -->
                    </div>

                    <div id="saleCart" class="border-t border-gray-200 pt-4 hidden">
                        <h4 class="font-bold mb-3">Carrito de Venta</h4>
                        <div id="saleCartItems" class="space-y-2 mb-4">
                            <!-- Los items del carrito se mostrarán aquí -->
                        </div>
                        <div class="border-t border-gray-200 pt-3">
                            <div class="flex justify-between items-center font-bold text-lg">
                                <span>Total:</span>
                                <span id="saleTotal">$0</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button onclick="closeQuickSaleModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button onclick="processQuickSale()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600" id="processSaleBtn" disabled>
                            <i class="fas fa-cash-register mr-2"></i>Procesar Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div id="stockAdjustmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold" id="adjustmentTitle">Ajustar Stock</h3>
                    <button onclick="closeStockAdjustmentModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="adjustmentInfo" class="mb-4">
                    <!-- La información del producto se cargará aquí -->
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Ajuste</label>
                        <select id="adjustmentType" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="add">Agregar Stock</option>
                            <option value="remove">Quitar Stock</option>
                            <option value="set">Establecer Stock</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                        <input type="number" id="adjustmentQuantity" min="1" 
                               class="w-full p-3 border border-gray-300 rounded-lg" value="1">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Razón/Motivo</label>
                        <textarea id="adjustmentReason" rows="2" 
                                  class="w-full p-3 border border-gray-300 rounded-lg"
                                  placeholder="Ej: Compra nueva, daño, etc."></textarea>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeStockAdjustmentModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button onclick="saveStockAdjustment()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        Guardar Ajuste
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let editingProductId = null;
        let currentAdjustmentProductId = null;
        let allProducts = [];
        let saleCart = [];
        const defaultCategories = [
            'Suplementos',
            'Bebidas',
            'Ropa Deportiva',
            'Accesorios',
            'Equipamiento',
            'Nutrición',
            'Vitaminas',
            'Proteínas',
            'Creatina',
            'Pre-workout'
        ];

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        function logout() {
            AuthManager.logout();
            window.location.href = 'index.html';
        }

        // Modal Functions
        function showAddProductModal() {
            editingProductId = null;
            document.getElementById('productModalTitle').textContent = 'Agregar Nuevo Producto';
            document.getElementById('productSubmitText').textContent = 'Guardar Producto';
            document.getElementById('productForm').reset();
            loadCategoriesForSelect();
            document.getElementById('productActive').checked = true;
            document.getElementById('addProductModal').classList.remove('hidden');
        }

        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.add('hidden');
            editingProductId = null;
        }

        function showProductDetails(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('detailProductName').textContent = product.name;
            
            const sales = LocalStorageDriver.getAll('sales');
            const productSales = sales.filter(s => 
                s.products && s.products.some(p => p.product_id === productId)
            );

            document.getElementById('productDetailsContent').innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${product.stock}</div>
                            <div class="text-sm text-gray-600">Stock Actual</div>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">${productSales.length}</div>
                            <div class="text-sm text-gray-600">Ventas Totales</div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Información del Producto</label>
                            <div class="mt-2 space-y-2 text-sm">
                                <p><strong>Nombre:</strong> ${product.name}</p>
                                <p><strong>Categoría:</strong> ${product.category}</p>
                                <p><strong>SKU:</strong> ${product.sku || 'No especificado'}</p>
                                <p><strong>Proveedor:</strong> ${product.supplier || 'No especificado'}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Precios</label>
                                <div class="mt-2 space-y-1 text-sm">
                                    <p><strong>Compra:</strong> ${product.cost ? Utilities.formatCurrency(product.cost) : 'No especificado'}</p>
                                    <p><strong>Venta:</strong> ${Utilities.formatCurrency(product.price)}</p>
                                    ${product.cost ? `<p><strong>Margen:</strong> ${calculateMargin(product.cost, product.price)}%</p>` : ''}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Stock</label>
                                <div class="mt-2 space-y-1 text-sm">
                                    <p><strong>Actual:</strong> ${product.stock}</p>
                                    <p><strong>Mínimo:</strong> ${product.min_stock || 'No definido'}</p>
                                    <p><strong>Máximo:</strong> ${product.max_stock || 'No definido'}</p>
                                </div>
                            </div>
                        </div>

                        ${product.description ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Descripción</label>
                            <p class="mt-1 text-sm text-gray-600">${product.description}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('editProductBtn').onclick = () => {
                closeProductDetailsModal();
                editProduct(productId);
            };

            document.getElementById('productDetailsModal').classList.remove('hidden');
        }

        function closeProductDetailsModal() {
            document.getElementById('productDetailsModal').classList.add('hidden');
        }

        function showQuickSaleModal() {
            saleCart = [];
            document.getElementById('saleProductSearch').value = '';
            document.getElementById('saleCart').classList.add('hidden');
            document.getElementById('processSaleBtn').disabled = true;
            loadProductsForSale();
            document.getElementById('quickSaleModal').classList.remove('hidden');
        }

        function closeQuickSaleModal() {
            document.getElementById('quickSaleModal').classList.add('hidden');
            saleCart = [];
        }

        function showStockAdjustmentModal(productId) {
            currentAdjustmentProductId = productId;
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('adjustmentTitle').textContent = `Ajustar Stock - ${product.name}`;
            document.getElementById('adjustmentInfo').innerHTML = `
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-sm"><strong>Stock actual:</strong> ${product.stock}</p>
                    <p class="text-sm"><strong>Stock mínimo:</strong> ${product.min_stock || 'No definido'}</p>
                </div>
            `;
            document.getElementById('adjustmentQuantity').value = 1;
            document.getElementById('adjustmentReason').value = '';
            document.getElementById('stockAdjustmentModal').classList.remove('hidden');
        }

        function closeStockAdjustmentModal() {
            document.getElementById('stockAdjustmentModal').classList.add('hidden');
            currentAdjustmentProductId = null;
        }

        // Categories Management
        function loadCategoriesForSelect() {
            const categories = getCategories();
            const select = document.getElementById('productCategory');
            const filterSelect = document.getElementById('categoryFilter');
            
            select.innerHTML = '<option value="">Seleccionar categoría...</option>';
            filterSelect.innerHTML = '<option value="all">Todas las categorías</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);

                const filterOption = document.createElement('option');
                filterOption.value = category;
                filterOption.textContent = category;
                filterSelect.appendChild(filterOption);
            });
        }

        function getCategories() {
            const products = LocalStorageDriver.getAll('products');
            const categories = new Set(defaultCategories);
            
            products.forEach(product => {
                if (product.category) {
                    categories.add(product.category);
                }
            });
            
            return Array.from(categories).sort();
        }

        function showCategoriesModal() {
            Utilities.showToast('Gestión de categorías en desarrollo', 'error');
        }

        // Data Loading
        function loadInventoryData() {
            const user = AuthManager.getCurrentUser();
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('userName').textContent = `${user.name} ${user.last_name || ''}`;
            loadProducts();
            loadStats();
            checkLowStock();
        }

        function loadProducts() {
            allProducts = LocalStorageDriver.getAll('products');
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            
            let filteredProducts = allProducts;

            if (categoryFilter !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }

            if (stockFilter !== 'all') {
                switch (stockFilter) {
                    case 'in_stock':
                        filteredProducts = filteredProducts.filter(p => p.stock > (p.min_stock || 5));
                        break;
                    case 'low_stock':
                        filteredProducts = filteredProducts.filter(p => p.stock <= (p.min_stock || 5) && p.stock > 0);
                        break;
                    case 'out_of_stock':
                        filteredProducts = filteredProducts.filter(p => p.stock === 0);
                        break;
                }
            }

            renderProductsTable(filteredProducts);
        }

        function loadStats() {
            const products = allProducts;

            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('inStockProducts').textContent = products.filter(p => p.stock > (p.min_stock || 5)).length;
            document.getElementById('lowStockProducts').textContent = products.filter(p => p.stock <= (p.min_stock || 5) && p.stock > 0).length;
            document.getElementById('outOfStockProducts').textContent = products.filter(p => p.stock === 0).length;
        }

        function checkLowStock() {
            const lowStockProducts = allProducts.filter(p => p.stock <= (p.min_stock || 5) && p.stock > 0);
            
            if (lowStockProducts.length > 0) {
                const alert = document.getElementById('lowStockAlert');
                const message = document.getElementById('lowStockMessage');
                
                message.textContent = `${lowStockProducts.length} productos tienen stock bajo. Considera reabastecer.`;
                alert.classList.remove('hidden');
            }
        }

        function hideLowStockAlert() {
            document.getElementById('lowStockAlert').classList.add('hidden');
        }

        // Render Functions
        function renderProductsTable(products) {
            const container = document.getElementById('productsTable');
            const emptyState = document.getElementById('emptyState');

            if (products.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = '';

            products.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-box text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${product.name}</div>
                                <div class="text-sm text-gray-500">${product.sku || 'Sin SKU'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 hidden md:table-cell">
                        ${product.category}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center">
                            <span class="font-medium">${product.stock}</span>
                            ${product.min_stock && product.stock <= product.min_stock ? `
                                <i class="fas fa-exclamation-triangle text-orange-500 ml-2" title="Stock bajo"></i>
                            ` : ''}
                            ${product.stock === 0 ? `
                                <i class="fas fa-times-circle text-red-500 ml-2" title="Sin stock"></i>
                            ` : ''}
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 hidden lg:table-cell">
                        ${Utilities.formatCurrency(product.price)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStockStatusClass(product)}">
                            ${getStockStatusText(product)}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="showProductDetails('${product.id}')" class="text-blue-600 hover:text-blue-900" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editProduct('${product.id}')" class="text-yellow-600 hover:text-yellow-900" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="showStockAdjustmentModal('${product.id}')" class="text-green-600 hover:text-green-900" title="Ajustar stock">
                                <i class="fas fa-warehouse"></i>
                            </button>
                            <button onclick="quickSellProduct('${product.id}')" class="text-purple-600 hover:text-purple-900" title="Venta rápida">
                                <i class="fas fa-cash-register"></i>
                            </button>
                            <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                container.appendChild(row);
            });
        }

        // Product Actions
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                sku: document.getElementById('productSKU').value || null,
                supplier: document.getElementById('productSupplier').value || null,
                cost: parseInt(document.getElementById('productCost').value) || null,
                price: parseInt(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                min_stock: parseInt(document.getElementById('productMinStock').value) || null,
                max_stock: parseInt(document.getElementById('productMaxStock').value) || null,
                description: document.getElementById('productDescription').value,
                active: document.getElementById('productActive').checked
            };

            try {
                if (editingProductId) {
                    LocalStorageDriver.update('products', editingProductId, productData);
                    Utilities.showToast('Producto actualizado exitosamente');
                } else {
                    LocalStorageDriver.create('products', productData);
                    Utilities.showToast('Producto agregado exitosamente');
                }
                
                closeAddProductModal();
                loadProducts();
                loadStats();
                checkLowStock();
            } catch (error) {
                Utilities.showToast('Error al guardar el producto', 'error');
            }
        });

        // Calculate margin on cost/price change
        document.getElementById('productCost').addEventListener('input', calculateMarginDisplay);
        document.getElementById('productPrice').addEventListener('input', calculateMarginDisplay);

        function calculateMarginDisplay() {
            const cost = parseInt(document.getElementById('productCost').value) || 0;
            const price = parseInt(document.getElementById('productPrice').value) || 0;
            
            if (cost > 0 && price > 0) {
                const margin = calculateMargin(cost, price);
                document.getElementById('productMargin').value = `${margin}%`;
            } else {
                document.getElementById('productMargin').value = '';
            }
        }

        function calculateMargin(cost, price) {
            return Math.round(((price - cost) / cost) * 100);
        }

        function editProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            editingProductId = productId;
            document.getElementById('productModalTitle').textContent = 'Editar Producto';
            document.getElementById('productSubmitText').textContent = 'Actualizar Producto';
            
            // Llenar formulario con datos del producto
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productSKU').value = product.sku || '';
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('productCost').value = product.cost || '';
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productMinStock').value = product.min_stock || '';
            document.getElementById('productMaxStock').value = product.max_stock || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productActive').checked = product.active !== false;

            loadCategoriesForSelect();
            calculateMarginDisplay();
            document.getElementById('addProductModal').classList.remove('hidden');
        }

        function deleteProduct(productId) {
            // Verificar si el producto tiene ventas asociadas
            const sales = LocalStorageDriver.getAll('sales');
            const productSales = sales.filter(s => 
                s.products && s.products.some(p => p.product_id === productId)
            );
            
            if (productSales.length > 0) {
                Utilities.showToast(`No se puede eliminar: El producto tiene ${productSales.length} ventas asociadas`, 'error');
                return;
            }

            if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                LocalStorageDriver.delete('products', productId);
                Utilities.showToast('Producto eliminado exitosamente');
                loadProducts();
                loadStats();
                checkLowStock();
            }
        }

        // Stock Adjustment
        function saveStockAdjustment() {
            if (!currentAdjustmentProductId) return;

            const product = allProducts.find(p => p.id === currentAdjustmentProductId);
            if (!product) return;

            const type = document.getElementById('adjustmentType').value;
            const quantity = parseInt(document.getElementById('adjustmentQuantity').value);
            const reason = document.getElementById('adjustmentReason').value;

            if (!quantity || quantity < 1) {
                Utilities.showToast('La cantidad debe ser mayor a 0', 'error');
                return;
            }

            let newStock = product.stock;
            switch (type) {
                case 'add':
                    newStock += quantity;
                    break;
                case 'remove':
                    newStock = Math.max(0, newStock - quantity);
                    break;
                case 'set':
                    newStock = quantity;
                    break;
            }

            try {
                LocalStorageDriver.update('products', currentAdjustmentProductId, { stock: newStock });
                
                // Registrar el movimiento de stock
                const movementData = {
                    product_id: currentAdjustmentProductId,
                    type: type,
                    quantity: quantity,
                    previous_stock: product.stock,
                    new_stock: newStock,
                    reason: reason,
                    date: new Date().toISOString()
                };
                LocalStorageDriver.create('stock_movements', movementData);

                Utilities.showToast('Stock ajustado exitosamente');
                closeStockAdjustmentModal();
                loadProducts();
                loadStats();
                checkLowStock();
            } catch (error) {
                Utilities.showToast('Error al ajustar el stock', 'error');
            }
        }

        // Quick Sale Functions
        function loadProductsForSale() {
            const products = allProducts.filter(p => p.active !== false && p.stock > 0);
            const container = document.getElementById('saleProductsList');
            
            container.innerHTML = products.map(product => `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                    <div class="flex-1">
                        <h4 class="font-medium">${product.name}</h4>
                        <div class="text-sm text-gray-600">
                            <span>Stock: ${product.stock}</span>
                            <span class="mx-2">•</span>
                            <span>${Utilities.formatCurrency(product.price)}</span>
                        </div>
                    </div>
                    <button onclick="addToSaleCart('${product.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-plus mr-1"></i>Agregar
                    </button>
                </div>
            `).join('');
        }

        function searchProductsForSale() {
            const searchTerm = document.getElementById('saleProductSearch').value.toLowerCase();
            const products = allProducts.filter(p => p.active !== false && p.stock > 0);
            const container = document.getElementById('saleProductsList');
            
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                (product.sku && product.sku.toLowerCase().includes(searchTerm))
            );

            container.innerHTML = filteredProducts.map(product => `
                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                    <div class="flex-1">
                        <h4 class="font-medium">${product.name}</h4>
                        <div class="text-sm text-gray-600">
                            <span>Stock: ${product.stock}</span>
                            <span class="mx-2">•</span>
                            <span>${Utilities.formatCurrency(product.price)}</span>
                        </div>
                    </div>
                    <button onclick="addToSaleCart('${product.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-plus mr-1"></i>Agregar
                    </button>
                </div>
            `).join('');
        }

        function addToSaleCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const existingItem = saleCart.find(item => item.product_id === productId);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity += 1;
                    existingItem.total = existingItem.quantity * product.price;
                } else {
                    Utilities.showToast('No hay suficiente stock disponible', 'error');
                    return;
                }
            } else {
                saleCart.push({
                    product_id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    total: product.price
                });
            }

            updateSaleCart();
        }

        function updateSaleCart() {
            const container = document.getElementById('saleCartItems');
            const totalElement = document.getElementById('saleTotal');
            const saleCartElement = document.getElementById('saleCart');
            const processBtn = document.getElementById('processSaleBtn');

            if (saleCart.length === 0) {
                saleCartElement.classList.add('hidden');
                processBtn.disabled = true;
                return;
            }

            saleCartElement.classList.remove('hidden');
            processBtn.disabled = false;

            container.innerHTML = saleCart.map((item, index) => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <div class="flex-1">
                        <h5 class="font-medium">${item.name}</h5>
                        <div class="text-sm text-gray-600">
                            ${Utilities.formatCurrency(item.price)} x ${item.quantity}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-bold">${Utilities.formatCurrency(item.total)}</span>
                        <button onclick="removeFromSaleCart(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            const total = saleCart.reduce((sum, item) => sum + item.total, 0);
            totalElement.textContent = Utilities.formatCurrency(total);
        }

        function removeFromSaleCart(index) {
            saleCart.splice(index, 1);
            updateSaleCart();
        }

        function processQuickSale() {
            if (saleCart.length === 0) return;

            // Verificar stock disponible
            for (const item of saleCart) {
                const product = allProducts.find(p => p.id === item.product_id);
                if (!product || product.stock < item.quantity) {
                    Utilities.showToast(`No hay suficiente stock de ${item.name}`, 'error');
                    return;
                }
            }

            // Crear venta
            const saleData = {
                products: saleCart.map(item => ({
                    product_id: item.product_id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                total: saleCart.reduce((sum, item) => sum + item.total, 0),
                date: new Date().toISOString(),
                type: 'quick_sale'
            };

            try {
                // Guardar venta
                LocalStorageDriver.create('sales', saleData);

                // Actualizar stock de productos
                saleCart.forEach(item => {
                    const product = allProducts.find(p => p.id === item.product_id);
                    if (product) {
                        const newStock = product.stock - item.quantity;
                        LocalStorageDriver.update('products', item.product_id, { stock: newStock });
                    }
                });

                Utilities.showToast('Venta procesada exitosamente');
                closeQuickSaleModal();
                loadProducts();
                loadStats();
                checkLowStock();
            } catch (error) {
                Utilities.showToast('Error al procesar la venta', 'error');
            }
        }

        function quickSellProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            showQuickSaleModal();
            // Agregar automáticamente el producto al carrito
            setTimeout(() => {
                addToSaleCart(productId);
            }, 100);
        }

        // Utility Functions
        function getStockStatusClass(product) {
            if (product.stock === 0) {
                return 'bg-red-100 text-red-800';
            } else if (product.min_stock && product.stock <= product.min_stock) {
                return 'bg-orange-100 text-orange-800';
            } else {
                return 'bg-green-100 text-green-800';
            }
        }

        function getStockStatusText(product) {
            if (product.stock === 0) {
                return 'Sin Stock';
            } else if (product.min_stock && product.stock <= product.min_stock) {
                return 'Stock Bajo';
            } else {
                return 'En Stock';
            }
        }

        function filterProducts() {
            loadProducts();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadInventoryData();
            loadCategoriesForSelect();
        });
    </script>
</body>
</html>