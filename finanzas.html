<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas - PowerGym</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="shared.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="dashboard.html" class="text-white hover:text-blue-200">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-xl font-bold">游눯 Gesti칩n Financiera</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="userName" class="hidden md:block"></span>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span class="hidden md:inline">Salir</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="bg-blue-500 text-white p-2 md:hidden">
        <button onclick="goToDashboard()" class="w-full text-left">
            <i class="fas fa-arrow-left mr-2"></i> Volver al Dashboard
        </button>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Financial Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="totalRevenue">$0</div>
                <div class="text-gray-600 text-sm">Ingresos Totales</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-red-600" id="totalExpenses">$0</div>
                <div class="text-gray-600 text-sm">Gastos Totales</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="netProfit">$0</div>
                <div class="text-gray-600 text-sm">Utilidad Neta</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="profitMargin">0%</div>
                <div class="text-gray-600 text-sm">Margen de Ganancia</div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="flex space-x-4">
                    <button onclick="showAddExpenseModal()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-plus mr-2"></i> Nuevo Gasto
                    </button>
                    <button onclick="showFinancialReport()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-chart-bar mr-2"></i> Reporte Completo
                    </button>
                    <button onclick="exportFinancialData()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-file-export mr-2"></i> Exportar Datos
                    </button>
                </div>
                <div class="flex space-x-2">
                    <select id="periodFilter" onchange="loadFinancialData()" class="p-2 border border-gray-300 rounded-lg">
                        <option value="today">Hoy</option>
                        <option value="week">Esta Semana</option>
                        <option value="month" selected>Este Mes</option>
                        <option value="quarter">Este Trimestre</option>
                        <option value="year">Este A침o</option>
                        <option value="all">Todo el Tiempo</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Revenue vs Expenses Chart -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold mb-4">Ingresos vs Gastos</h3>
                <div class="h-64">
                    <canvas id="revenueExpensesChart"></canvas>
                </div>
            </div>

            <!-- Revenue by Category -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold mb-4">Ingresos por Categor칤a</h3>
                <div class="h-64">
                    <canvas id="revenueByCategoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Financial Data -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Recent Transactions -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Transacciones Recientes</h3>
                        <div class="flex space-x-2">
                            <select id="transactionFilter" onchange="loadTransactions()" class="p-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">Todas</option>
                                <option value="income">Solo Ingresos</option>
                                <option value="expense">Solo Gastos</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci칩n</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categor칤a</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable" class="bg-white divide-y divide-gray-200">
                                <!-- Las transacciones se cargar치n aqu칤 -->
                            </tbody>
                        </table>
                    </div>

                    <div id="emptyTransactions" class="text-center py-8 hidden">
                        <i class="fas fa-exchange-alt text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900">No hay transacciones</h3>
                        <p class="text-gray-500">Las transacciones aparecer치n aqu칤.</p>
                    </div>
                </div>
            </div>

            <!-- Expense Categories Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4">Gastos por Categor칤a</h3>
                    <div id="expenseCategories" class="space-y-3">
                        <!-- Las categor칤as de gastos se cargar치n aqu칤 -->
                    </div>

                    <div id="emptyExpenses" class="text-center py-8 hidden">
                        <i class="fas fa-receipt text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No hay gastos registrados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Performance -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h3 class="text-lg font-bold mb-4">Rendimiento Mensual</h3>
            <div class="h-80">
                <canvas id="monthlyPerformanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Registrar Nuevo Gasto</h3>
                    <button onclick="closeAddExpenseModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="expenseForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descripci칩n *</label>
                        <input type="text" id="expenseDescription" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Ej: Pago de servicios, compra de equipos...">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Monto (COP) *</label>
                            <input type="number" id="expenseAmount" required min="0" step="100"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="50000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Categor칤a *</label>
                            <select id="expenseCategory" required 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Seleccionar categor칤a...</option>
                                <option value="n칩mina">N칩mina</option>
                                <option value="alquiler">Alquiler</option>
                                <option value="servicios">Servicios P칰blicos</option>
                                <option value="equipos">Equipos y Mantenimiento</option>
                                <option value="marketing">Marketing y Publicidad</option>
                                <option value="suplementos">Compra de Suplementos</option>
                                <option value="impuestos">Impuestos</option>
                                <option value="otros">Otros Gastos</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
                            <input type="date" id="expenseDate" required 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">M칠todo de Pago</label>
                            <select id="expensePaymentMethod" 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="efectivo">Efectivo</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="tarjeta">Tarjeta</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor/Recibidor</label>
                        <input type="text" id="expenseProvider" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Nombre del proveedor">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notas</label>
                        <textarea id="expenseNotes" rows="2"
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Informaci칩n adicional del gasto..."></textarea>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeAddExpenseModal()" 
                                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Guardar Gasto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Financial Report Modal -->
    <div id="financialReportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Reporte Financiero Completo</h3>
                    <div class="flex space-x-2">
                        <button onclick="printFinancialReport()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-print mr-2"></i>Imprimir
                        </button>
                        <button onclick="closeFinancialReport()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <div id="financialReportContent">
                    <!-- El contenido del reporte se generar치 aqu칤 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let revenueExpensesChart = null;
        let revenueByCategoryChart = null;
        let monthlyPerformanceChart = null;

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        function logout() {
            AuthManager.logout();
            window.location.href = 'index.html';
        }

        // Modal Functions
        function showAddExpenseModal() {
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addExpenseModal').classList.remove('hidden');
        }

        function closeAddExpenseModal() {
            document.getElementById('addExpenseModal').classList.add('hidden');
        }

        function showFinancialReport() {
            generateFinancialReport();
            document.getElementById('financialReportModal').classList.remove('hidden');
        }

        function closeFinancialReport() {
            document.getElementById('financialReportModal').classList.add('hidden');
        }

        // Data Loading
        function loadFinancialData() {
            const user = AuthManager.getCurrentUser();
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('userName').textContent = `${user.name} ${user.last_name || ''}`;
            loadFinancialOverview();
            loadTransactions();
            loadExpenseCategories();
            loadCharts();
        }

        function loadFinancialOverview() {
            const period = document.getElementById('periodFilter').value;
            const { startDate, endDate } = getDateRange(period);

            // Calcular ingresos (ventas + membres칤as)
            const sales = getSalesInPeriod(startDate, endDate);
            const memberships = getMembershipRevenue(startDate, endDate);
            const totalRevenue = sales + memberships;

            // Calcular gastos
            const expenses = getExpensesInPeriod(startDate, endDate);
            const totalExpenses = expenses;

            // Calcular m칠tricas
            const netProfit = totalRevenue - totalExpenses;
            const profitMargin = totalRevenue > 0 ? Math.round((netProfit / totalRevenue) * 100) : 0;

            // Actualizar UI
            document.getElementById('totalRevenue').textContent = Utilities.formatCurrency(totalRevenue);
            document.getElementById('totalExpenses').textContent = Utilities.formatCurrency(totalExpenses);
            document.getElementById('netProfit').textContent = Utilities.formatCurrency(netProfit);
            document.getElementById('profitMargin').textContent = `${profitMargin}%`;
        }

        function getDateRange(period) {
            const now = new Date();
            let startDate, endDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now);
                    endDate = new Date(now);
                    break;
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    endDate = new Date(now);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    endDate = new Date(now.getFullYear(), (quarter + 1) * 3, 0);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
                case 'all':
                    startDate = new Date(0);
                    endDate = new Date();
                    break;
            }

            return { startDate, endDate };
        }

        function getSalesInPeriod(startDate, endDate) {
            const sales = LocalStorageDriver.getAll('sales');
            return sales
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= startDate && saleDate <= endDate;
                })
                .reduce((sum, sale) => sum + sale.total, 0);
        }

        function getMembershipRevenue(startDate, endDate) {
            // Simular ingresos por membres칤as (en una implementaci칩n real, esto vendr칤a de una base de datos de pagos)
            const members = LocalStorageDriver.getAll('members').filter(m => m.status === 'active');
            const plans = LocalStorageDriver.getAll('plans');
            
            return members.reduce((sum, member) => {
                const plan = plans.find(p => p.id === member.plan_id);
                return plan ? sum + plan.price : sum;
            }, 0);
        }

        function getExpensesInPeriod(startDate, endDate) {
            const expenses = LocalStorageDriver.getAll('expenses');
            return expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= startDate && expenseDate <= endDate;
                })
                .reduce((sum, expense) => sum + expense.amount, 0);
        }

        function loadTransactions() {
            const period = document.getElementById('periodFilter').value;
            const transactionType = document.getElementById('transactionFilter').value;
            const { startDate, endDate } = getDateRange(period);

            const sales = LocalStorageDriver.getAll('sales')
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= startDate && saleDate <= endDate;
                })
                .map(sale => ({
                    id: sale.id,
                    date: sale.date,
                    description: `Venta - ${sale.products.length} productos`,
                    category: 'ventas',
                    amount: sale.total,
                    type: 'income',
                    payment_method: sale.payment_method
                }));

            const expenses = LocalStorageDriver.getAll('expenses')
                .filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= startDate && expenseDate <= endDate;
                })
                .map(expense => ({
                    id: expense.id,
                    date: expense.date,
                    description: expense.description,
                    category: expense.category,
                    amount: expense.amount,
                    type: 'expense',
                    payment_method: expense.payment_method
                }));

            let transactions = [...sales, ...expenses];

            // Filtrar por tipo si es necesario
            if (transactionType !== 'all') {
                transactions = transactions.filter(t => t.type === transactionType);
            }

            // Ordenar por fecha (m치s reciente primero)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            renderTransactions(transactions);
        }

        function renderTransactions(transactions) {
            const container = document.getElementById('transactionsTable');
            const emptyState = document.getElementById('emptyTransactions');

            if (transactions.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = '';

            transactions.slice(0, 10).forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(transaction.date).toLocaleDateString('es-CO')}
                    </td>
                    <td class="px-4 py-4 text-sm text-gray-900">
                        ${transaction.description}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs">${transaction.category}</span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${transaction.type === 'income' ? '+' : '-'}${Utilities.formatCurrency(transaction.amount)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 py-1 rounded text-xs ${transaction.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${transaction.type === 'income' ? 'INGRESO' : 'GASTO'}
                        </span>
                    </td>
                `;
                container.appendChild(row);
            });
        }

        function loadExpenseCategories() {
            const period = document.getElementById('periodFilter').value;
            const { startDate, endDate } = getDateRange(period);

            const expenses = LocalStorageDriver.getAll('expenses')
                .filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= startDate && expenseDate <= endDate;
                });

            const categories = {};
            expenses.forEach(expense => {
                if (!categories[expense.category]) {
                    categories[expense.category] = 0;
                }
                categories[expense.category] += expense.amount;
            });

            renderExpenseCategories(categories);
        }

        function renderExpenseCategories(categories) {
            const container = document.getElementById('expenseCategories');
            const emptyState = document.getElementById('emptyExpenses');

            if (Object.keys(categories).length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = '';

            Object.entries(categories)
                .sort(([,a], [,b]) => b - a)
                .forEach(([category, amount]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                    categoryDiv.innerHTML = `
                        <span class="text-sm font-medium">${getExpenseCategoryText(category)}</span>
                        <span class="text-red-600 font-bold">${Utilities.formatCurrency(amount)}</span>
                    `;
                    container.appendChild(categoryDiv);
                });
        }

        function getExpenseCategoryText(category) {
            const categories = {
                'n칩mina': 'N칩mina',
                'alquiler': 'Alquiler',
                'servicios': 'Servicios',
                'equipos': 'Equipos',
                'marketing': 'Marketing',
                'suplementos': 'Suplementos',
                'impuestos': 'Impuestos',
                'otros': 'Otros',
                'ventas': 'Ventas'
            };
            return categories[category] || category;
        }

        // Chart Functions
        function loadCharts() {
            loadRevenueExpensesChart();
            loadRevenueByCategoryChart();
            loadMonthlyPerformanceChart();
        }

        function loadRevenueExpensesChart() {
            const ctx = document.getElementById('revenueExpensesChart').getContext('2d');
            const period = document.getElementById('periodFilter').value;
            const { startDate, endDate } = getDateRange(period);

            const sales = getSalesInPeriod(startDate, endDate);
            const memberships = getMembershipRevenue(startDate, endDate);
            const expenses = getExpensesInPeriod(startDate, endDate);

            if (revenueExpensesChart) {
                revenueExpensesChart.destroy();
            }

            revenueExpensesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Gastos'],
                    datasets: [{
                        label: 'Monto en COP',
                        data: [sales + memberships, expenses],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Utilities.formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return Utilities.formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadRevenueByCategoryChart() {
            const ctx = document.getElementById('revenueByCategoryChart').getContext('2d');
            const period = document.getElementById('periodFilter').value;
            const { startDate, endDate } = getDateRange(period);

            const sales = getSalesInPeriod(startDate, endDate);
            const memberships = getMembershipRevenue(startDate, endDate);

            if (revenueByCategoryChart) {
                revenueByCategoryChart.destroy();
            }

            revenueByCategoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ventas de Productos', 'Membres칤as'],
                    datasets: [{
                        data: [sales, memberships],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(139, 92, 246)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = sales + memberships;
                                    const percentage = Math.round((value / total) * 100);
                                    return `${Utilities.formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadMonthlyPerformanceChart() {
            const ctx = document.getElementById('monthlyPerformanceChart').getContext('2d');
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const currentYear = new Date().getFullYear();

            const monthlyData = months.map((month, index) => {
                const startDate = new Date(currentYear, index, 1);
                const endDate = new Date(currentYear, index + 1, 0);
                
                const revenue = getSalesInPeriod(startDate, endDate) + getMembershipRevenue(startDate, endDate);
                const expenses = getExpensesInPeriod(startDate, endDate);
                const profit = revenue - expenses;

                return { revenue, expenses, profit };
            });

            if (monthlyPerformanceChart) {
                monthlyPerformanceChart.destroy();
            }

            monthlyPerformanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: monthlyData.map(d => d.revenue),
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Gastos',
                            data: monthlyData.map(d => d.expenses),
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Utilidad',
                            data: monthlyData.map(d => d.profit),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Utilities.formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${Utilities.formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Expense Management
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const expenseData = {
                description: document.getElementById('expenseDescription').value,
                amount: parseInt(document.getElementById('expenseAmount').value),
                category: document.getElementById('expenseCategory').value,
                date: document.getElementById('expenseDate').value,
                payment_method: document.getElementById('expensePaymentMethod').value,
                provider: document.getElementById('expenseProvider').value || null,
                notes: document.getElementById('expenseNotes').value || null
            };

            try {
                LocalStorageDriver.create('expenses', expenseData);
                Utilities.showToast('Gasto registrado exitosamente');
                closeAddExpenseModal();
                loadFinancialData();
            } catch (error) {
                Utilities.showToast('Error al registrar el gasto', 'error');
            }
        });

        // Report Generation
        function generateFinancialReport() {
            const period = document.getElementById('periodFilter').value;
            const { startDate, endDate } = getDateRange(period);

            const sales = getSalesInPeriod(startDate, endDate);
            const memberships = getMembershipRevenue(startDate, endDate);
            const expenses = getExpensesInPeriod(startDate, endDate);
            const netProfit = sales + memberships - expenses;
            const profitMargin = (sales + memberships) > 0 ? Math.round((netProfit / (sales + memberships)) * 100) : 0;

            const reportContent = document.getElementById('financialReportContent');
            reportContent.innerHTML = `
                <div class="space-y-6">
                    <div class="text-center mb-6">
                        <h4 class="text-2xl font-bold">REPORTE FINANCIERO</h4>
                        <p class="text-gray-600">PowerGym - ${period.toUpperCase()}</p>
                        <p class="text-sm text-gray-500">Generado el ${new Date().toLocaleDateString('es-CO')}</p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-xl font-bold text-green-600">${Utilities.formatCurrency(sales + memberships)}</div>
                            <div class="text-sm text-gray-600">Ingresos Totales</div>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-xl font-bold text-red-600">${Utilities.formatCurrency(expenses)}</div>
                            <div class="text-sm text-gray-600">Gastos Totales</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-xl font-bold text-blue-600">${Utilities.formatCurrency(netProfit)}</div>
                            <div class="text-sm text-gray-600">Utilidad Neta</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-xl font-bold text-purple-600">${profitMargin}%</div>
                            <div class="text-sm text-gray-600">Margen de Ganancia</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="font-bold mb-3">Desglose de Ingresos</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>Ventas de Productos:</span>
                                    <span class="font-bold">${Utilities.formatCurrency(sales)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Membres칤as:</span>
                                    <span class="font-bold">${Utilities.formatCurrency(memberships)}</span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="font-bold">Total Ingresos:</span>
                                    <span class="font-bold">${Utilities.formatCurrency(sales + memberships)}</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h5 class="font-bold mb-3">Desglose de Gastos</h5>
                            <div class="space-y-2">
                                ${getExpenseBreakdown(startDate, endDate)}
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h5 class="font-bold mb-3">An치lisis de Rentabilidad</h5>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Margen Bruto:</span>
                                <span class="${profitMargin >= 0 ? 'text-green-600' : 'text-red-600'} font-bold">${profitMargin}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Relaci칩n Gastos/Ingresos:</span>
                                <span class="font-bold">${Math.round((expenses / (sales + memberships)) * 100)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ROI Aproximado:</span>
                                <span class="font-bold">${Math.round((netProfit / expenses) * 100)}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getExpenseBreakdown(startDate, endDate) {
            const expenses = LocalStorageDriver.getAll('expenses')
                .filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= startDate && expenseDate <= endDate;
                });

            const categories = {};
            expenses.forEach(expense => {
                if (!categories[expense.category]) {
                    categories[expense.category] = 0;
                }
                categories[expense.category] += expense.amount;
            });

            let html = '';
            Object.entries(categories)
                .sort(([,a], [,b]) => b - a)
                .forEach(([category, amount]) => {
                    html += `
                        <div class="flex justify-between">
                            <span>${getExpenseCategoryText(category)}:</span>
                            <span class="font-bold">${Utilities.formatCurrency(amount)}</span>
                        </div>
                    `;
                });

            html += `
                <div class="flex justify-between border-t pt-2">
                    <span class="font-bold">Total Gastos:</span>
                    <span class="font-bold">${Utilities.formatCurrency(Object.values(categories).reduce((a, b) => a + b, 0))}</span>
                </div>
            `;

            return html;
        }

        function printFinancialReport() {
            const reportContent = document.getElementById('financialReportContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Reporte Financiero - PowerGym</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 14px; padding: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
                        .metric { text-align: center; padding: 15px; border-radius: 8px; }
                        .breakdown { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
                        .analysis { background: #f9fafb; padding: 15px; border-radius: 8px; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    ${reportContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function exportFinancialData() {
            Utilities.showToast('Funcionalidad de exportaci칩n en desarrollo', 'error');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFinancialData();
            
            // Establecer fecha actual como valor por defecto en el formulario de gastos
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        });
    </script>
</body>
</html>